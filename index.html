<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>forscore-pdf-optimizer</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        padding: 2rem;
      }
      .card {
        max-width: 720px;
        margin: 0 auto;
        padding: 1.5rem;
        border: 1px solid #ddd;
        border-radius: 12px;
      }
      h1 {
        margin-top: 0;
        font-size: 1.4rem;
      }
      form {
        display: grid;
        gap: 0.75rem;
        margin-top: 1rem;
      }
      input[type="file"] {
        padding: 0.75rem;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      button {
        padding: 0.75rem 1rem;
        border: 0;
        border-radius: 8px;
        cursor: pointer;
        background: #111;
        color: #fff;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .help {
        color: #555;
        font-size: 0.95rem;
      }
      ul {
        margin-top: 0.25rem;
      }
      .muted {
        color: #666;
        font-size: 0.9rem;
        margin-top: 1rem;
      }
      code {
        background: #f5f5f5;
        padding: 0 0.25rem;
        border-radius: 4px;
      }
      .block {
        background: #f8f8f8;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        padding: 0.75rem;
        overflow-x: auto;
      }
      .alert {
        display: none;
        padding: 0.75rem;
        border-radius: 8px;
        margin-top: 0.75rem;
      }
      .alert.error {
        display: block;
        background: #fee;
        border: 1px solid #f8b4b4;
        color: #911;
      }
      .alert.success {
        display: block;
        background: #eefaf0;
        border: 1px solid #bde5c8;
        color: #1b5e20;
      }
      .row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .row > * {
        flex: 1 1 auto;
      }
      .row button {
        flex: 0 0 auto;
      }
      .small {
        font-size: 0.9rem;
        color: #555;
      }

      /* Preserve newlines/whitespace for the curl example */
      #curl-example {
        white-space: pre;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>forscore-pdf-optimizer</h1>

      <p class="help">
        <a
          href="https://www.icloud.com/shortcuts/fd2240209d5c4264b792cd4be398a9a2"
          title="iOS Shortcuts"
          >Add to iOS Shortcuts</a
        >.
      </p>

      <p class="help">
        <strong>PRO TIP for ForScore users:</strong>
        <ol>
          <li>Install iOS shortcut using link above</li>
          <li>Open ForScore, and go to an annoyingly laggy PDF</li>
          <li>Share the original PDF</li>
          <li>In the share menu, scroll down until you see "Edit Actions..."</li>
          <li>Find "ForScore PDF Optimizer" and add it to favorites, and hit done</li>
          <li>Click on "ForScore PDF Optimizer"</li>
          <li>After it's done processing, there should be a popup. Check to see if there's any defects</li>
          <li>If you're satisfied, click on Share, "Save to Files", and then navigate to On My iPad, forScore, and see if the files are there. If not, go to iCloud Drive and check there.</li>
          <li>Once you're sure the original laggy PDF exists in the forScore folder, click Save, and "Replace".</li>
          <li>Reopen ForScore and you should have a laggy-free PDF.</li>
        </ol>
      </p>

      <p class="help">
        <strong>If you don't need iOS shortcuts, use this instead:</strong>
        <a href="https://laurentmmeyer.github.io/ghostscript-pdf-compress.wasm/"
          >laurentmmeyer.github.io/ghostscript-pdf-compress.wasm/</a
        >
      </p>

      <form
        id="upload-form"
        action="/upload"
        method="post"
        enctype="multipart/form-data"
      >
        <div class="row">
          <input
            id="file-input"
            type="file"
            name="file"
            accept="application/pdf"
            required
          />
          <button id="submit-btn" type="submit">Optimize PDF</button>
        </div>
        <div id="alert" class="alert" role="status" aria-live="polite"></div>
        <div id="jobinfo" class="small"></div>
      </form>

      <p class="help">
        <strong>How this works in a nutshell:</strong> Reduces the PDF's image
        resolution to <strong>&lt;300 DPI</strong> as well as other
        optimizations.
      </p>

      <p class="help">
        <strong>Why ForScore can feel slow:</strong> Many scores from IMSLP come
        at <em>&gt;1200 DPI</em> or higher, which is overkill and can slow down
        your iPad. This tool trims DPI to around 264–300 while keeping quality
        high.
      </p>

      <p class="help">
        <strong>Only for ForScore?</strong> No, this can also be used for other
        PDF-reader apps that have difficulty displaying super-high DPI PDFs. I
        mainly created this because I use ForScore and it really chokes on those
        IMSLP files.
      </p>

      <p class="help">
        <strong>For the technically inclined: Behind the scenes, the following is run on the server:</strong>
      </p>
      <div class="block">
        <code
          >gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook
          -dNOPAUSE -dQUIET -dBATCH -dColorConversionStrategy=/LeaveColorUnchanged -sOutputFile=output.pdf input.pdf</code
        >
      </div>

      <p class="help"><strong>For the technically inclined: Use from the command line:</strong></p>
      <div class="block">
        <code id="curl-example"></code>
      </div>

      <p class="muted">
        Created with help of ChatGPT · Licensed MIT · Source:
        <a
          href="https://github.com/binary-person/forscore-pdf-optimizer"
          target="_blank"
          rel="noopener"
        >
          github.com/binary-person/forscore-pdf-optimizer
        </a>
      </p>
    </div>

    <script>
      (function () {
        const form = document.getElementById("upload-form");
        const fileInput = document.getElementById("file-input");
        const submitBtn = document.getElementById("submit-btn");
        const alertBox = document.getElementById("alert");
        const jobInfo = document.getElementById("jobinfo");
        const curlEl = document.getElementById("curl-example");

        // Build curl example with preserved newlines
        const base = new URL("/", window.location.href).href.replace(
          /\/+$/,
          ""
        );
        curlEl.textContent = `# Upload -> get job id
JOB=$(curl -s -F "file=@/path/to/your.pdf" ${base}/upload | jq -r .jobId)

# Poll until ready
until [ "$(curl -s ${base}/status/$JOB | jq -r .status)" = "done" ]; do sleep 2; done

# Download (expires after download or after 5 minutes of inactivity)
curl -L -o optimized.pdf ${base}/download/$JOB`;

        function setAlert(type, msg) {
          alertBox.className = "alert " + (type ? type : "");
          alertBox.textContent = msg || "";
          alertBox.style.display = type ? "" : "none";
        }

        function disableUI(disabled, label) {
          submitBtn.disabled = disabled;
          submitBtn.textContent = disabled
            ? label || "Processing…"
            : "Optimize PDF";
          fileInput.disabled = disabled;
        }

        let pollTimer = null;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          setAlert("", "");
          jobInfo.textContent = "";
          if (!fileInput.files || !fileInput.files[0]) {
            setAlert("error", "Please choose a PDF file first.");
            return;
          }

          const originalName = fileInput.files[0].name || "optimized.pdf";
          disableUI(true, "Uploading…");

          try {
            const fd = new FormData();
            fd.append("file", fileInput.files[0]);
            const resp = await fetch(form.action, { method: "POST", body: fd });
            const data = await resp.json().catch(() => ({}));

            if (!resp.ok || !data.jobId) {
              const text = (data && data.error) || "Upload failed.";
              setAlert("error", text);
              disableUI(false);
              return;
            }

            const jobId = data.jobId;
            jobInfo.textContent = `Job: ${jobId}. Waiting for processing…`;
            setAlert("success", "Upload successful. Processing started.");

            const poll = async () => {
              try {
                const s = await fetch(`${base}/status/${jobId}`).then((r) =>
                  r.json()
                );
                if (s.status === "done") {
                  clearInterval(pollTimer);
                  jobInfo.textContent = `Job: ${jobId}. Ready. Starting download…`;
                  setAlert("success", "Optimized file is ready. Downloading…");

                  const a = document.createElement("a");
                  a.href = `${base}/download/${jobId}`;
                  a.download = originalName;
                  document.body.appendChild(a);
                  a.click();
                  a.remove();

                  disableUI(false);
                  form.reset();
                } else if (s.status === "error") {
                  clearInterval(pollTimer);
                  setAlert("error", s.message || "Processing failed.");
                  disableUI(false);
                } else if (s.status === "expired") {
                  clearInterval(pollTimer);
                  setAlert("error", "The job has expired. Please re-upload.");
                  disableUI(false);
                }
              } catch (_) {
                /* ignore transient errors */
              }
            };
            pollTimer = setInterval(poll, 2000);
            poll();
          } catch (err) {
            setAlert("error", "Processing failed. Please try again.");
            disableUI(false);
          }
        });
      })();
    </script>
  </body>
</html>
